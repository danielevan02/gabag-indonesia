name: Deploy to Staging

on:
  push:
    branches:
      - main  # Auto-deploy ketika push ke main branch

jobs:
  deploy:
    name: Deploy to VPS Staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # Exit immediately if any command fails
            set -o pipefail  # Catch errors in pipes

            cd /var/www/gabag-indonesia

            # Save current commit for rollback
            PREVIOUS_COMMIT=$(git rev-parse HEAD)
            echo "ğŸ“Œ Current commit before deployment: $PREVIOUS_COMMIT"

            echo "ğŸ”„ Pulling latest code from GitHub..."
            git pull origin main

            NEW_COMMIT=$(git rev-parse HEAD)
            echo "ğŸ“Œ New commit after pull: $NEW_COMMIT"

            # Function to rollback on failure
            rollback() {
              echo "âŒ Deployment failed! Rolling back to $PREVIOUS_COMMIT..."
              git reset --hard $PREVIOUS_COMMIT
              pnpm install --frozen-lockfile || true
              pnpm prisma generate || true
              pm2 restart gabag-indonesia || true
              exit 1
            }

            echo "ğŸ“¦ Installing dependencies..."
            pnpm install --frozen-lockfile || rollback

            echo "ğŸ—„ï¸  Running database migrations..."
            pnpm prisma migrate deploy || rollback
            pnpm prisma generate || rollback

            echo "ğŸ—ï¸  Building Next.js application..."
            pnpm build || rollback

            echo "â™»ï¸  Restarting PM2 application..."
            pm2 restart gabag-indonesia || rollback

            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“Œ Deployed commit: $NEW_COMMIT"
            pm2 status
